<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Ashika Jain Yoga Studio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,400&family=Montserrat:wght@300;400;500;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="admin-style.css">
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Configuration -->
    <script src="config.js"></script>
</head>

<body>
    <div class="admin-container">
        <!-- Admin Header -->
        <header class="admin-header">
            <div class="admin-header-content">
                <div class="admin-logo">
                    <div class="logo-circle">AJ</div>
                    <h2>Admin <span class="highlight">Dashboard</span></h2>
                </div>
                <div class="admin-header-actions">
                    <a href="blog.html" class="view-site-btn" target="_blank">
                        <i class="fa-solid fa-external-link-alt"></i> View Site
                    </a>
                    <button class="logout-btn" id="logout-btn">
                        <i class="fa-solid fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </header>

        <div class="admin-main">
            <!-- Sidebar -->
            <aside class="admin-sidebar">
                <nav class="admin-nav">
                    <a href="#blogs" class="nav-item active" data-section="blogs">
                        <i class="fa-solid fa-blog"></i>
                        <span>Blog Posts</span>
                    </a>
                    <a href="#add-blog" class="nav-item" data-section="add-blog">
                        <i class="fa-solid fa-plus-circle"></i>
                        <span>Add New Post</span>
                    </a>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="admin-content">
                <!-- Blogs List Section -->
                <section id="blogs-section" class="admin-section active">
                    <div class="section-header">
                        <h1>Blog Posts</h1>
                        <button class="btn-primary" id="add-new-btn">
                            <i class="fa-solid fa-plus"></i> Add New Post
                        </button>
                    </div>

                    <div class="blogs-table-container">
                        <div id="blogs-loading" class="loading-state">
                            <i class="fa-solid fa-spinner fa-spin"></i> Loading blogs...
                        </div>
                        <div id="blogs-error" class="error-state" style="display: none;"></div>
                        <table class="blogs-table" id="blogs-table" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="blogs-tbody">
                                <!-- Blogs will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- Add/Edit Blog Section -->
                <section id="add-blog-section" class="admin-section">
                    <div class="section-header">
                        <h1 id="form-title">Add New Blog Post</h1>
                        <button class="btn-secondary" id="back-to-list-btn">
                            <i class="fa-solid fa-arrow-left"></i> Back to List
                        </button>
                    </div>

                    <form id="blog-form" class="blog-form">
                        <input type="hidden" id="blog-id" name="id">

                        <div class="form-row">
                            <div class="form-group">
                                <label for="title">Title *</label>
                                <input type="text" id="title" name="title" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="category">Category</label>
                                <div class="category-input-wrapper">
                                    <select id="category" name="category">
                                        <option value="">Select or enter custom category</option>
                                        <option value="GENERAL">GENERAL</option>
                                        <option value="MINDFULNESS">MINDFULNESS</option>
                                        <option value="PRACTICE">PRACTICE</option>
                                        <option value="BREATHWORK">BREATHWORK</option>
                                        <option value="COMMUNITY">COMMUNITY</option>
                                        <option value="NUTRITION">NUTRITION</option>
                                        <option value="MEDITATION">MEDITATION</option>
                                        <option value="__custom__">+ Add New Category</option>
                                    </select>
                                    <input type="text" id="category-custom" name="category-custom" placeholder="Enter custom category" style="display: none; margin-top: 10px;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="image_upload">Blog Image</label>
                                <div class="image-upload-wrapper">
                                    <div class="image-upload-area" id="image-upload-area">
                                        <input type="file" id="image_upload" name="image_upload" accept="image/*" style="display: none;">
                                        <div class="upload-placeholder" id="upload-placeholder">
                                            <i class="fa-solid fa-cloud-arrow-up"></i>
                                            <p>Click to upload or drag and drop</p>
                                            <span>PNG, JPG, GIF up to 5MB</span>
                                        </div>
                                        <div class="image-preview" id="image-preview" style="display: none;">
                                            <img id="preview-image" src="" alt="Preview">
                                            <button type="button" class="remove-image-btn" id="remove-image-btn">
                                                <i class="fa-solid fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="image-url-fallback">
                                        <label for="image_url" style="font-size: 0.7rem; color: var(--secondary-text); margin-top: 10px; display: block;">Or enter image URL:</label>
                                        <input type="text" id="image_url" name="image_url" placeholder="e.g., https://example.com/image.png" style="margin-top: 5px;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="excerpt">Excerpt</label>
                            <textarea id="excerpt" name="excerpt" rows="3" placeholder="Short description of the blog post"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="content">Content</label>
                            <textarea id="content" name="content" rows="10" placeholder="Full blog post content"></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="slug">Slug (URL-friendly)</label>
                                <input type="text" id="slug" name="slug" placeholder="e.g., finding-peace-in-nature">
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="published" name="published" checked>
                                    <span>Published</span>
                                </label>
                            </div>
                        </div>

                        <div id="form-error" class="error-message" style="display: none;"></div>

                        <div class="form-actions">
                            <button type="submit" class="btn-primary" id="submit-btn">
                                <i class="fa-solid fa-save"></i> Save Post
                            </button>
                            <button type="button" class="btn-secondary" id="cancel-btn">
                                Cancel
                            </button>
                        </div>
                    </form>
                </section>
            </main>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Delete Blog Post</h3>
            <p>Are you sure you want to delete this blog post? This action cannot be undone.</p>
            <div class="modal-actions">
                <button class="btn-danger" id="confirm-delete">Delete</button>
                <button class="btn-secondary" id="cancel-delete">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = SUPABASE_CONFIG.url;
        const SUPABASE_ANON_KEY = SUPABASE_CONFIG.anonKey;
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentBlogId = null;
        let blogs = [];

        // Check authentication
        supabase.auth.getSession().then(({ data: { session } }) => {
            if (!session) {
                window.location.href = 'admin-login.html';
            }
        });

        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.href = 'admin-login.html';
        });

        // Navigation
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const section = item.getAttribute('data-section');
                showSection(section);
            });
        });

        function showSection(section) {
            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-section="${section}"]`).classList.add('active');

            // Update sections
            document.querySelectorAll('.admin-section').forEach(sec => {
                sec.classList.remove('active');
            });

            if (section === 'blogs') {
                document.getElementById('blogs-section').classList.add('active');
                loadBlogs();
            } else if (section === 'add-blog') {
                document.getElementById('add-blog-section').classList.add('active');
                resetForm();
            }
        }

        // Add new button
        document.getElementById('add-new-btn').addEventListener('click', () => {
            showSection('add-blog');
        });

        // Back to list button
        document.getElementById('back-to-list-btn').addEventListener('click', () => {
            showSection('blogs');
        });

        // Cancel button
        document.getElementById('cancel-btn').addEventListener('click', () => {
            showSection('blogs');
        });

        // Load blogs
        async function loadBlogs() {
            const loadingDiv = document.getElementById('blogs-loading');
            const errorDiv = document.getElementById('blogs-error');
            const table = document.getElementById('blogs-table');
            const tbody = document.getElementById('blogs-tbody');

            loadingDiv.style.display = 'block';
            errorDiv.style.display = 'none';
            table.style.display = 'none';

            try {
                const { data, error } = await supabase
                    .from('blogs')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                blogs = data || [];
                renderBlogsTable();
            } catch (error) {
                console.error('Error loading blogs:', error);
                errorDiv.textContent = 'Failed to load blogs. Please try again.';
                errorDiv.style.display = 'block';
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        // Render blogs table
        function renderBlogsTable() {
            const tbody = document.getElementById('blogs-tbody');
            const table = document.getElementById('blogs-table');

            if (blogs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">No blog posts found.</td></tr>';
            } else {
                tbody.innerHTML = blogs.map(blog => `
                    <tr>
                        <td><strong>${blog.title || 'Untitled'}</strong></td>
                        <td><span class="category-badge">${blog.category || 'GENERAL'}</span></td>
                        <td>${formatDate(blog.created_at)}</td>
                        <td>
                            <span class="status-badge ${blog.published ? 'published' : 'draft'}">
                                ${blog.published ? 'Published' : 'Draft'}
                            </span>
                        </td>
                        <td>
                            <button class="btn-icon edit-btn" data-id="${blog.id}" title="Edit">
                                <i class="fa-solid fa-edit"></i>
                            </button>
                            <button class="btn-icon delete-btn" data-id="${blog.id}" title="Delete">
                                <i class="fa-solid fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                // Add event listeners
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', () => editBlog(btn.getAttribute('data-id')));
                });

                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', () => confirmDelete(btn.getAttribute('data-id')));
                });
            }

            table.style.display = 'table';
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        // Edit blog
        function editBlog(id) {
            const blog = blogs.find(b => b.id === id);
            if (!blog) return;

            currentBlogId = id;
            document.getElementById('blog-id').value = blog.id;
            document.getElementById('title').value = blog.title || '';
            
            // Handle category (check if it's a custom category)
            const categorySelect = document.getElementById('category');
            const customCategoryInput = document.getElementById('category-custom');
            const existingCategory = blog.category || 'GENERAL';
            
            // Check if category exists in select options
            const categoryOption = Array.from(categorySelect.options).find(opt => opt.value === existingCategory);
            if (categoryOption) {
                categorySelect.value = existingCategory;
                customCategoryInput.style.display = 'none';
            } else {
                categorySelect.value = '__custom__';
                customCategoryInput.value = existingCategory;
                customCategoryInput.style.display = 'block';
            }

            // Set image preview if image exists
            const imageUrl = blog.image_url || blog.image || '';
            if (imageUrl) {
                document.getElementById('image_url').value = imageUrl;
                previewImage.src = imageUrl;
                uploadPlaceholder.style.display = 'none';
                imagePreview.style.display = 'block';
                uploadedImageUrl = imageUrl;
            } else {
                uploadPlaceholder.style.display = 'block';
                imagePreview.style.display = 'none';
                uploadedImageUrl = null;
            }

            document.getElementById('excerpt').value = blog.excerpt || '';
            document.getElementById('content').value = blog.content || '';
            document.getElementById('slug').value = blog.slug || '';
            document.getElementById('published').checked = blog.published !== false;

            document.getElementById('form-title').textContent = 'Edit Blog Post';
            showSection('add-blog');
        }

        // Reset form
        function resetForm() {
            currentBlogId = null;
            uploadedImageUrl = null;
            document.getElementById('blog-form').reset();
            document.getElementById('blog-id').value = '';
            document.getElementById('published').checked = true;
            document.getElementById('form-title').textContent = 'Add New Blog Post';
            document.getElementById('form-error').style.display = 'none';
            
            // Reset image preview
            uploadPlaceholder.style.display = 'block';
            imagePreview.style.display = 'none';
            previewImage.src = '';
            document.getElementById('image_url').value = '';
            
            // Reset category
            document.getElementById('category').value = '';
            document.getElementById('category-custom').style.display = 'none';
            document.getElementById('category-custom').value = '';
        }

        // Confirm delete
        function confirmDelete(id) {
            currentBlogId = id;
            document.getElementById('delete-modal').style.display = 'flex';
        }

        // Cancel delete
        document.getElementById('cancel-delete').addEventListener('click', () => {
            document.getElementById('delete-modal').style.display = 'none';
            currentBlogId = null;
        });

        // Confirm delete action
        document.getElementById('confirm-delete').addEventListener('click', async () => {
            if (!currentBlogId) return;

            try {
                const { error } = await supabase
                    .from('blogs')
                    .delete()
                    .eq('id', currentBlogId);

                if (error) throw error;

                document.getElementById('delete-modal').style.display = 'none';
                loadBlogs();
                currentBlogId = null;
            } catch (error) {
                console.error('Error deleting blog:', error);
                alert('Failed to delete blog. Please try again.');
            }
        });

        // Handle form submission
        document.getElementById('blog-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Get category (handle custom category)
            let category = document.getElementById('category').value;
            if (category === '__custom__') {
                const customCategory = document.getElementById('category-custom').value.trim();
                category = customCategory ? customCategory.toUpperCase() : 'GENERAL';
            }

            // Get image URL (prioritize uploaded image)
            let imageUrl = uploadedImageUrl || document.getElementById('image_url').value;

            const formData = {
                title: document.getElementById('title').value,
                category: category,
                image_url: imageUrl,
                excerpt: document.getElementById('excerpt').value,
                content: document.getElementById('content').value,
                slug: document.getElementById('slug').value,
                published: document.getElementById('published').checked
            };

            const submitBtn = document.getElementById('submit-btn');
            const errorDiv = document.getElementById('form-error');
            const originalText = submitBtn.innerHTML;

            submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
            submitBtn.disabled = true;
            errorDiv.style.display = 'none';

            try {
                let result;
                if (currentBlogId) {
                    // Update existing blog
                    result = await supabase
                        .from('blogs')
                        .update(formData)
                        .eq('id', currentBlogId);
                } else {
                    // Insert new blog
                    result = await supabase
                        .from('blogs')
                        .insert([formData]);
                }

                if (result.error) throw result.error;

                // Success - go back to list
                showSection('blogs');
            } catch (error) {
                console.error('Error saving blog:', error);
                errorDiv.textContent = error.message || 'Failed to save blog. Please try again.';
                errorDiv.style.display = 'block';
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Auto-generate slug from title
        document.getElementById('title').addEventListener('blur', () => {
            const title = document.getElementById('title').value;
            const slug = document.getElementById('slug');
            if (title && !slug.value) {
                slug.value = title.toLowerCase()
                    .replace(/[^a-z0-9]+/g, '-')
                    .replace(/(^-|-$)/g, '');
            }
        });

        // Image Upload Functionality
        const imageUpload = document.getElementById('image_upload');
        const imageUploadArea = document.getElementById('image-upload-area');
        const uploadPlaceholder = document.getElementById('upload-placeholder');
        const imagePreview = document.getElementById('image-preview');
        const previewImage = document.getElementById('preview-image');
        const removeImageBtn = document.getElementById('remove-image-btn');
        let uploadedImageUrl = null;

        // Click to upload
        imageUploadArea.addEventListener('click', () => {
            if (!imagePreview.style.display || imagePreview.style.display === 'none') {
                imageUpload.click();
            }
        });

        // File input change
        imageUpload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            // Validate file size (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image size must be less than 5MB');
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                uploadPlaceholder.style.display = 'none';
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);

            // Upload to Supabase
            await uploadImageToSupabase(file);
        });

        // Drag and drop
        imageUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageUploadArea.classList.add('drag-over');
        });

        imageUploadArea.addEventListener('dragleave', () => {
            imageUploadArea.classList.remove('drag-over');
        });

        imageUploadArea.addEventListener('drop', async (e) => {
            e.preventDefault();
            imageUploadArea.classList.remove('drag-over');

            const file = e.dataTransfer.files[0];
            if (!file || !file.type.startsWith('image/')) {
                alert('Please drop an image file');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                alert('Image size must be less than 5MB');
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                uploadPlaceholder.style.display = 'none';
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);

            // Upload to Supabase
            await uploadImageToSupabase(file);
        });

        // Remove image
        removeImageBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            uploadedImageUrl = null;
            imageUpload.value = '';
            imagePreview.style.display = 'none';
            uploadPlaceholder.style.display = 'block';
            document.getElementById('image_url').value = '';
        });

        // Upload image to Supabase Storage
        async function uploadImageToSupabase(file) {
            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.innerHTML;

            try {
                submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Uploading image...';
                submitBtn.disabled = true;

                // Generate unique filename
                const fileExt = file.name.split('.').pop();
                const fileName = `${Date.now()}-${Math.random().toString(36).substring(2, 15)}.${fileExt}`;
                const filePath = `blog-images/${fileName}`;

                // Upload to Supabase Storage
                const { data, error } = await supabase.storage
                    .from('blog-images')
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) throw error;

                // Get public URL
                const { data: urlData } = supabase.storage
                    .from('blog-images')
                    .getPublicUrl(filePath);

                uploadedImageUrl = urlData.publicUrl;
                document.getElementById('image_url').value = uploadedImageUrl;

                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            } catch (error) {
                console.error('Error uploading image:', error);
                alert('Failed to upload image. Please try again or use image URL instead.');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }

        // Handle category custom input
        document.getElementById('category').addEventListener('change', (e) => {
            const customInput = document.getElementById('category-custom');
            if (e.target.value === '__custom__') {
                customInput.style.display = 'block';
                customInput.required = true;
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
        });

        // Load blogs on page load
        loadBlogs();
    </script>
</body>

</html>
